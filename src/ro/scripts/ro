#!/usr/bin/env python3
"""
ro - Real-time command output viewer with tmux integration.

Execute shell commands as you type in an interactive shell with aliases.
Creates a tmux split: top pane shows output, bottom pane is the input line.

The shell runs inside macOS sandbox-exec with file writes denied for safety,
since commands execute on every keystroke.

Usage: ro [initial command]

Key bindings:
  Ctrl-C/Esc  - Exit
  Alt-Up/Down - Navigate history
  Ctrl-K      - Clear to end of line
  Ctrl-U      - Clear to start of line
  Ctrl-W      - Delete word backward
"""

import os
import shlex
import subprocess
import sys
from pathlib import Path

HISTORY_FILE = Path.home() / ".ro_history"

# macOS sandbox policy template: allow everything except file writes to user directories
# Must allow: /dev/null, /dev/tty, PTY devices, /tmp for basic shell operation
# Also allow: atuin database writes
SANDBOX_POLICY_TEMPLATE = """
(version 1)
(allow default)
(deny file-write*
    (subpath "/Users")
)
(allow file-write*
    (subpath "/dev")
    (subpath "/tmp")
    (subpath "/private/tmp")
    (subpath "/var/folders")
    (subpath "{home}/.local/share/atuin")
)
"""


def main() -> None:
    if not os.environ.get("TMUX"):
        print("Error: ro requires tmux", file=sys.stderr)
        sys.exit(1)

    initial_query = " ".join(sys.argv[1:]) if len(sys.argv) > 1 else ""
    shell = os.environ.get("SHELL", "/bin/zsh")
    sandbox_policy = SANDBOX_POLICY_TEMPLATE.format(home=Path.home()).strip()

    # Split window: create shell pane above (90% of height)
    # -b: create pane before (above) current
    # -l 90%: give it 90% of the space
    # -P -F: print the new pane's ID
    # Run shell inside sandbox-exec to prevent file writes
    # Shell needs -i (interactive) to source zshrc/bashrc
    output_pane = subprocess.check_output(
        [
            "tmux", "split-window", "-b", "-l", "90%", "-P", "-F", "#{pane_id}",
            "sandbox-exec", "-p", sandbox_policy, shell, "-i",
        ],
        text=True,
    ).strip()

    # Command to send to the shell pane on each change:
    # First check if shell is at prompt (not running a pager/editor)
    # Only send if foreground process is the shell itself
    # This prevents typing from disrupting less, vim, etc.
    shell_name = os.path.basename(shell)  # e.g., "zsh" from "/opt/homebrew/bin/zsh"
    send_cmd = (
        f"fg=$(tmux display-message -t {output_pane} -p '#{{pane_current_command}}'); "
        f"if [ \"$fg\" = \"{shell_name}\" ] || [ \"$fg\" = \"sandbox-exec\" ]; then "
        f"tmux send-keys -t {output_pane} C-c C-u C-l && "
        f"tmux send-keys -t {output_pane} -l {{q}} && "
        f"tmux send-keys -t {output_pane} Enter; "
        f"fi"
    )

    # Command for initial startup - includes delay to let shell fully initialize
    # (zshrc sourcing takes time, prompt setup and alias definitions need to complete)
    # Note: no C-l here so startup errors remain visible for debugging
    start_cmd = (
        f"sleep 1.0 && "
        f"tmux send-keys -t {output_pane} C-c C-u && "
        f"tmux send-keys -t {output_pane} -l {{q}} && "
        f"tmux send-keys -t {output_pane} Enter"
    )

    fzf_cmd = [
        "fzf",
        "--disabled",
        "--height", "100%",
        "--layout", "reverse",
        "--info", "hidden",
        "--no-separator",
        "--prompt", "$ ",
        "--ansi",
        # Execute command in shell pane on start and on each change
        # start uses delay to let shell fully initialize (zshrc sourcing)
        "--bind", f"start:execute-silent:{start_cmd}",
        "--bind", f"change:execute-silent:{send_cmd}",
        # Enter is a no-op (use Ctrl-C or Esc to exit)
        "--bind", "enter:ignore",
        # History
        "--history", str(HISTORY_FILE),
        "--bind", "alt-up:prev-history",
        "--bind", "alt-down:next-history",
        # Line editing
        "--bind", "ctrl-k:kill-line",
        "--bind", "ctrl-u:unix-line-discard",
        "--bind", "ctrl-w:unix-word-rubout",
        "--bind", "alt-right:forward-word",
        "--bind", "alt-left:backward-word",
    ]

    if initial_query:
        fzf_cmd.extend(["--query", initial_query])

    try:
        fzf_cmd_str = " ".join(shlex.quote(arg) for arg in fzf_cmd)
        subprocess.call(f'echo "" | {fzf_cmd_str}', shell=True, executable="/bin/bash")
    finally:
        # Kill the shell pane we created
        subprocess.run(["tmux", "kill-pane", "-t", output_pane], check=False)


if __name__ == "__main__":
    main()
