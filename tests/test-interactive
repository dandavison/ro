#!/bin/bash

# test-interactive - Test interactive CLI programs by capturing their tmux output
#
# Usage: test-interactive <command> [sleep_time]
#   command: The command to run (will be executed with bash -c)
#   sleep_time: How long to wait before capturing (default 0.5 seconds)
#
# Example:
#   test-interactive "ro 'echo hello'"
#   test-interactive "ro 'ls -la'" 1

if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <command> [sleep_time]"
    echo "Example: $0 'ro \"echo hello\"' 0.5"
    exit 1
fi

COMMAND="$1"
SLEEP_TIME="${2:-0.5}"

# In CI environments, we might need extra time for processes to start
if [ "$CI" = "true" ]; then
    SLEEP_TIME=$(awk "BEGIN {print $SLEEP_TIME + 0.5}")
fi

SESSION_NAME="test-interactive-$$"
TMUX_SOCKET="test-socket-$$"

if ! command -v tmux &>/dev/null; then
    echo "Error: tmux is not installed" >&2
    exit 1
fi

# Cleanup from failed runs
tmux -L "$TMUX_SOCKET" kill-session -t "$SESSION_NAME" 2>/dev/null
tmux -L "$TMUX_SOCKET" kill-server 2>/dev/null

echo "=== Testing: $COMMAND ===" >&2
echo "=== Waiting ${SLEEP_TIME}s for UI to render ===" >&2

tmux -L "$TMUX_SOCKET" new-session -d -s "$SESSION_NAME" -c "$(pwd)" bash -c "$COMMAND"

sleep "$SLEEP_TIME"

echo "=== Captured output ===" >&2
tmux -L "$TMUX_SOCKET" capture-pane -t "$SESSION_NAME" -p

tmux -L "$TMUX_SOCKET" kill-session -t "$SESSION_NAME" 2>/dev/null
tmux -L "$TMUX_SOCKET" kill-server 2>/dev/null

echo "=== Test complete ===" >&2

